# 2-5. MCP + RAG + Gemini 파이프라인 구현 요약

## 목표
- Jetson이 보낸 위험 상황 텍스트를 서버에서 받아,
- RAG 기반 매뉴얼을 참조해 대응안을 생성하고,
- 관리자용 응답 + Jetson TTS 요약을 반환.

## 구현 파일
- `src/api/config.py`
- `src/api/models.py`
- `src/api/main.py`
- `src/api/services/pipeline.py`
- `src/api/services/mcp_rag.py`
- `src/api/services/local_rag.py`
- `src/api/services/llm_responder.py`
- `src/mcp/rag_server.py`
- `src/rag/default_manuals.json`
- `src/rag/manual_repository.py`

## 파이프라인
1. `POST /events/danger` 수신
2. MCP RAG 조회 시도
   - `retrieve_guidelines` 툴 호출
3. MCP 실패/타임아웃 시 local RAG fallback
4. 참고 문서 + 상황 설명으로 LLM 응답 생성
5. 구조화된 응답 반환:
   - `operator_response`
   - `jetson_tts_summary`

## RAG 구성
- MCP 서버: `src/mcp/rag_server.py`
- 기본 매뉴얼 데이터: `src/rag/default_manuals.json`
- 현재 전략:
  - Chroma 가능 시 우선 조회
  - 실패 시 키워드 매칭 fallback

## LLM 구성
- 기본 모델: `gemini-3-flash-preview`
- Gemini structured output 적용:
  - `response_mime_type: application/json`
  - `response_json_schema: GeminiSafetyResponse.model_json_schema()`
- Pydantic 검증:
  - `GeminiSafetyResponse.model_validate_json(...)`

## 알려진 이슈
- stdio MCP가 요청 단위로 재기동되는 로그가 발생할 수 있음.
- 간헐적인 timeout 발생 가능.

## 개선 방향(현재 전략 유지)
- MCP 유지한 상태로 재기동/타임아웃 완화.
- 필요 시 streamable_http 상시 MCP 서버로 전환.

