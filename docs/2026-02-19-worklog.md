# SentinelHybrid 작업 로그 (2026-02-19)

## 1) 오늘 작업 요약
- Jetson Edge 파이프라인에서 Gemma3:4b(Ollama) 추론과 Mac FastAPI 전송 흐름을 재검증.
- Mac에서 FastAPI + RAG MCP + Ops MCP(Discord) 동시 구동으로 E2E 확인.
- `.env` 공백 파싱 이슈(인자/커맨드 문자열) 수정.
- Edge 하드웨어 알림 로직 보강:
  - GPIO 백엔드 폴백 안정화
  - RGB 채널 매핑 보정
  - 평시(초록)/위험(빨강) LED 상태 전환 추가
- GitHub 이슈/브랜치/커밋/푸시 완료.

## 2) 주요 확인/검증 내용

### Edge 파이프라인
- Jetson에서 `python3 -m src.edge.main` 실행 시 루프 동작 확인.
- `Danger event sent: status=200` 로그로 Mac FastAPI(`/events/danger`) 수신 확인.
- 서버 응답의 `jetson_tts_summary`를 Edge에서 받아 TTS 출력 확인.
- 사이렌 mp3 단독 재생(`ffplay`) 확인 완료.

### Cloud/API/MCP
- Mac에서 아래 3개 프로세스 동시 구동:
  - FastAPI 서버
  - RAG MCP 서버(`streamable-http`)
  - Ops MCP 서버(`streamable-http`)
- Admin 대시보드에서 이벤트/응답 카운트 및 `rag_source` 확인.

### 품질 관련 관찰
- Gemini 429(무료티어 쿼터) 발생 시 fallback 템플릿 응답으로 전환.
- 위험이 아닌 장면에서도 `DANGER` 치우침이 일부 존재해 응답 품질 저하 체감.

## 3) 코드 변경 사항

### A. Discord webhook payload 정리
- 파일: `src/mcp/ops_server.py`
- 변경: payload key `text` -> `content`.

### B. Edge VLM raw 로그 저장
- 파일:
  - `src/edge/vlm_client.py`
  - `src/edge/config.py`
  - `src/edge/main.py`
- 변경:
  - `EDGE_VLM_RAW_LOG_ENABLED`, `EDGE_VLM_RAW_LOG_PATH` 추가.
  - Ollama 성공/에러/fallback 결과 JSONL 저장.

### C. Edge 하드웨어 알림 경로 안정화
- 파일:
  - `src/edge/alerts.py`
  - `src/edge/config.py`
  - `src/edge/main.py`
- 변경:
  - `EDGE_GPIO_PIN_MODE`(`BCM`/`BOARD`) 지원.
  - `gpiozero` 실패 시 `Jetson.GPIO` 폴백.
  - siren command 실패 시 buzzer 폴백.
  - BOARD 모드 GND 핀 오설정 방어 로깅 추가.

### D. RGB LED 시뮬레이터 추가/보정
- 파일: `src/sim/rgb_led_cycle.py`
- 변경:
  - RGB 순환 테스트 스크립트 추가.
  - 장비 실측 기준 채널 매핑 보정:
    - `BOARD 22 -> R`
    - `BOARD 16 -> G`
    - `BOARD 18 -> B`

### E. 평시/위험 LED 상태 전환 추가
- 파일:
  - `src/edge/alerts.py`
  - `src/edge/config.py`
  - `src/edge/main.py`
- 변경:
  - `EDGE_SAFE_LED_PINS` 추가.
  - 상태 정책:
    - Idle: safe LED ON, danger LED OFF
    - Danger: safe LED OFF, danger LED ON
    - Danger 종료 후 idle 상태 복귀

## 4) Jetson LED enable 참고
- 일부 장비에서 GPIO mux 설정 필요 시:
```bash
sudo apt-get install -y busybox
sudo busybox devmem 0x243D020 w 0x5
sudo busybox devmem 0x243D010 w 0x5
sudo busybox devmem 0x243D000 w 0x5
```
- RGB 테스트 실행:
```bash
python3 -m src.sim.rgb_led_cycle
```

## 5) GitHub 작업 결과
- 이슈: [#19] [FIX] Edge 하드웨어 알림 경로 안정화 및 GPIO 핀 모드 분리
- 브랜치: `feat/19-edge-alert-gpio-pinmode-stability`
- 커밋:
  - `6656e0e` `fix: stabilize edge hardware alerts with pin mode and gpio fallback`
  - `1773a93` `chore: add Jetson RGB LED cycle simulator script`
  - `04249ff` `feat: add idle-safe LED state and update RGB channel mapping`
- 원격 푸시 완료: `origin/feat/19-edge-alert-gpio-pinmode-stability`

## 6) `.env` 관련 정리

### source 에러 원인/조치
- 원인: 공백 포함 값 미인용.
- 조치:
  - `RAG_MCP_ARGS="-m src.mcp.rag_server"`
  - `OPS_MCP_ARGS="-m src.mcp.ops_server"`
  - `EDGE_SIREN_COMMAND="ffplay -nodisp -autoexit -stream_loop -1 /home/junsu/Downloads/siren.mp3"`

### 현재 LED/사운드 권장값(실측 반영)
- `EDGE_GPIO_PIN_MODE=BOARD`
- `EDGE_DANGER_LED_PINS=22`
- `EDGE_SAFE_LED_PINS=16`
- `EDGE_BUZZER_GPIO_PIN=` (미사용)
- `EDGE_SIREN_COMMAND="ffplay -nodisp -autoexit -stream_loop -1 /home/junsu/Downloads/siren.mp3"`

## 7) 현재 남은 리스크
- Gemini free tier 쿼터(429)로 fallback 비율 상승 가능.
- Edge 분류 오탐(`DANGER` 치우침)으로 운영 문구 품질 저하 가능.
- 하드웨어 핀 매핑/저항/권한은 장비별 편차 존재.

## 8) 다음 작업(대기)
- 파이프라인 품질 개선:
  - Edge 분류 안정화(오탐 억제/게이팅).
  - hazard 일관성 강화(RAG reference 혼합 제어).
  - fallback 문구 품질 정리.
- Weather MCP 적용 검토.
